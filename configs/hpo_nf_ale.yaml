study:
    name: tuning_nf_aleatoric
    storage: "sqlite:///optuna_studies/hpo.db"
    direction: minimize
    resume: true

budget:
    n_trials: 30

resources:
    partition: "gpu"
    time: "00:50:00"
    mem_gb: 8
    cpus_per_task: 4
    gpus: 1
    max_parallel: 2

io:
    outputs_root: "outputs/optuna"
    logs_root: "logs"
    job_name_template: "{study}_{ts}_{jobid}"
    trial_dir_template: "trial_{trial:05d}"

base_config:
    train_config_path: "uncertainty_quantification/configs/nf_train.yaml"
    train_script_path: "uncertainty_quantification/scripts/train_flows.py"

repro:
    snapshot_hpo_config: true
    snapshot_base_config: true
    save_pip_freeze: false
    save_git_commit: false

# Fix role to aleatoric; tune depth/width/LR, etc.
search_space:
    - { name: "nf.role",              dist: "choice", choices: ["aleatoric"] }
    - { name: "training.lr",          dist: "loguniform", low: 1.0e-5, high: 3.0e-3 }
    - { name: "training.batch_size",  dist: "choice", choices: [512, 1024, 2048] }
    - { name: "nf.num_layers",        dist: "int", low: 2, high: 12 }
    - { name: "nf.hidden_features",   dist: "int", low: 64, high: 512, step: 32 }
    - { name: "nf.actnorm",           dist: "choice", choices: [true, false] }
    # Optional expressivity search:
    # - { name: "nf.transform",         dist: "choice", choices: ["affine","spline"] }
    # - { name: "nf.num_bins",          dist: "choice", choices: [8, 12] }

post_run:
    export_best: true
    best_dirname: "best"
    best_filename: "best_hparams.json"
    latest_pointer_dir: "outputs/optuna/{study}/best"
